<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seraph's Lag Stand</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', cursive; }
        canvas { 
            background-color: #110e1e; /* Cor base caso o gradiente n√£o carregue */
            cursor: crosshair;
            box-shadow: 0 0 20px rgba(130, 99, 255, 0.4); /* Brilho sutil ao redor do canvas */
        }
        #yt-player-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }
    </style>
</head>
<body>
    <div id="yt-player-container"></div>
    <canvas id="gameCanvas"></canvas>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
// --- GAME SETUP ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 1280; canvas.height = 720;
ctx.imageSmoothingEnabled = false;

// --- GAME STATE & CONSTANTS ---
const FONT_PRIMARY = '"Press Start 2P"';
const GRAVITY = 0.7;
let gameState = 'intro', menuState = 'main';
let gameTime = 0, score = 0, levelColorIndex = 0;
let introTimer = 5000, restartTimer = 0;
let gameDifficulty = 'medium';
let bossIsActive = false;

let player, terrain;
let enemies = [], playerProjectiles = [], enemyProjectiles = [], particles = [], floatingTexts = [];
let backgroundParticles = [], backgroundSpaceships = [];
let bossTimer, eventTimer, spaceshipSpawnTimer = 0;
let screenShake = { active: false, magnitude: 0, duration: 0 };

let skyCanvas, terrainCanvas, ytPlayer, isMusicReady = false, audioCtx;

// --- YOUTUBE API CALLBACKS ---
function onYouTubeIframeAPIReady() {ytPlayer = new YT.Player('yt-player-container', {height: '1', width: '1', events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }});}
function onPlayerReady(event) {isMusicReady = true; ytPlayer.setLoop(true);}
function onPlayerStateChange(event) { if (event.data === YT.PlayerState.ENDED) { ytPlayer.playVideo(); } }

// --- AUDIO ---
function initAudio() {if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } if (isMusicReady && ytPlayer) {ytPlayer.setVolume(gameData.settings.volume);}}
function playClickSound() {if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'triangle'; o.frequency.setValueAtTime(800, audioCtx.currentTime); g.gain.setValueAtTime(0.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1);}
function playDefeatSound() {if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(400, audioCtx.currentTime); g.gain.setValueAtTime(0.2, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 1.2); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.2); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 1.2);}
function playPowerUpSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.2);}
function playHitSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.08);}
function playKillSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15); g.gain.setValueAtTime(0.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.15);}
function playDamageSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.15); }
function playJumpSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'triangle'; o.frequency.setValueAtTime(440, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1); }
function playLevelUpSound() { if (!audioCtx) return; const notes = [523, 659, 783, 1046]; notes.forEach((note, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.setValueAtTime(note, audioCtx.currentTime + i * 0.07); g.gain.setValueAtTime(0.15, audioCtx.currentTime + i * 0.07); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + i * 0.07 + 0.1); o.start(audioCtx.currentTime + i * 0.07); o.stop(audioCtx.currentTime + i * 0.07 + 0.1); }); }
function playBossSpawnSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(120, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(60, audioCtx.currentTime + 1.5); g.gain.setValueAtTime(0.25, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.5); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 1.5); }
function playQuakeSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(100, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(40, audioCtx.currentTime + 0.3); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.3); }
function playHitSoundNightmare() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(80, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1); }
function playKillSoundNightmare() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(100, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.2); }
function playDamageSoundNightmare() { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(220, audioCtx.currentTime); g.gain.setValueAtTime(0.3, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.2); o.stop(audioCtx.currentTime + 0.2); o.start(); }

// --- THEMES & COLORS ---
const THEMES=[{bg:'#212121',platform:'#424242',platformTop:'#6E6E6E',detail:'#313131',text:'#ECEFF1',highlight:'#FBC02D',enemy:'#B71C1C',projectile:'#FDD835',hp:'#D32F2F',xp:'#1976D2',shadow:'#000000'},{bg:'#263238',platform:'#455A64',platformTop:'#607D8B',detail:'#37474F',text:'#ECEFF1',highlight:'#FFCA28',enemy:'#D84315',projectile:'#FFEE58',hp:'#F44336',xp:'#42A5F5',shadow:'#000000'},{bg:'#3E2723',platform:'#5D4037',platformTop:'#795548',detail:'#4E342E',text:'#D7CCC8',highlight:'#FFC107',enemy:'#E64A19',projectile:'#FFEB3B',hp:'#E53935',xp:'#039BE5',shadow:'#1B0000'},{bg:'#1A237E',platform:'#283593',platformTop:'#3949AB',detail:'#1A237E',text:'#E8EAF6',highlight:'#F57F17',enemy:'#C62828',projectile:'#AED581',hp:'#C62828',xp:'#64B5F6',shadow:'#000A2C'},{bg:'#004D40',platform:'#00695C',platformTop:'#00897B',detail:'#003D33',text:'#E0F2F1',highlight:'#F9A825',enemy:'#AD1457',projectile:'#FF8A65',hp:'#D81B60',xp:'#29B6F6',shadow:'#001A15'}];
let currentTheme = THEMES[0];

// --- PERSISTENT DATA ---
let gameData = { settings: { performanceMode: false, volume: 25 } };
function loadGameData() { const d=localStorage.getItem('seraphsLagStandData'); if(d){const s=JSON.parse(d);gameData.settings=Object.assign(gameData.settings,s.settings)}}
function saveGameData() { localStorage.setItem('seraphsLagStandData', JSON.stringify(gameData));}

// --- INPUT HANDLERS ---
const keys = { a:{p:false}, d:{p:false}, space:{p:false}, f:{p:false}, g:{p:false}, j:{p:false} };
const mouse = { x: canvas.width / 2, y: canvas.height / 2, down: false };

// --- DRAWING & TEXTURE FUNCTIONS ---
function generateBackground() {
    skyCanvas = document.createElement('canvas'); skyCanvas.width = canvas.width; skyCanvas.height = canvas.height;
    const skyCtx = skyCanvas.getContext('2d');
    terrainCanvas = document.createElement('canvas'); terrainCanvas.width = canvas.width; terrainCanvas.height = canvas.height;
    terrainCanvas.getContext('2d').imageSmoothingEnabled = false;
    const terrainCtx = terrainCanvas.getContext('2d');
    
    if (!gameData.settings.performanceMode) {
        // --- Enhanced Background ---
        const gradient = skyCtx.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width / 1.5);
        gradient.addColorStop(0, '#4a3b82');
        gradient.addColorStop(0.5, '#2c224d');
        gradient.addColorStop(1, '#110e1e');
        skyCtx.fillStyle = gradient;
        skyCtx.fillRect(0, 0, canvas.width, canvas.height);

        // Glowing Stars
        skyCtx.shadowColor = '#FFFFFF';
        for (let i = 0; i < 200; i++) {
            skyCtx.beginPath();
            skyCtx.fillStyle = `rgba(255, 255, 255, ${random(0.4, 1)})`;
            skyCtx.shadowBlur = random(3, 8);
            skyCtx.arc(random(0, canvas.width), random(0, canvas.height), random(0.5, 1.5), 0, Math.PI * 2);
            skyCtx.fill();
        }
        skyCtx.shadowBlur = 0; // Reset shadow

        // Glowing Planets
        skyCtx.shadowColor = '#f0f0f5'; skyCtx.shadowBlur = 40;
        skyCtx.fillStyle = '#f0f0f5'; skyCtx.beginPath(); skyCtx.arc(1100, 120, 50, 0, Math.PI * 2); skyCtx.fill();
        skyCtx.shadowColor = '#e85a5a'; skyCtx.shadowBlur = 20;
        skyCtx.fillStyle = '#e85a5a'; skyCtx.beginPath(); skyCtx.arc(150, 400, 20, 0, Math.PI * 2); skyCtx.fill();
        skyCtx.shadowBlur = 0;

        // --- Original Floor Texture (Unchanged per request) ---
        const tC = document.createElement('canvas'); tC.width = 16; tC.height = 16; const texCtx = tC.getContext('2d');
        texCtx.fillStyle = '#404040'; texCtx.fillRect(0,0,16,16); texCtx.fillStyle = '#303030'; texCtx.fillRect(0,0,8,8); texCtx.fillRect(8,8,8,8);
        const tP = terrainCtx.createPattern(tC, 'repeat');
        terrain.blocks.forEach(b=>{terrainCtx.fillStyle=`rgba(0,0,0,0.5)`;terrainCtx.fillRect(b.x+5,b.y+5,b.width,b.height)});
        terrain.blocks.forEach(b=>{terrainCtx.fillStyle=tP;terrainCtx.fillRect(b.x,b.y,b.width,b.height);terrainCtx.fillStyle='#606060';terrainCtx.fillRect(b.x,b.y,b.width,4)});
    } else { // Performance mode
        skyCanvas.getContext('2d').fillStyle = currentTheme.bg; skyCanvas.getContext('2d').fillRect(0,0,canvas.width,canvas.height);
        terrain.blocks.forEach(b => { terrainCtx.fillStyle=currentTheme.platform; terrainCtx.fillRect(b.x,b.y,b.width,b.height); terrainCtx.fillStyle=currentTheme.platformTop; terrainCtx.fillRect(b.x,b.y,b.width,4)});
    }
}
function drawPlayerSprite(p,theme){
    const x=p.x; const y=p.y;
    ctx.save();
    if (p && p.stats) {
        if(p.stats.activePowers.chronoShift.active){ctx.shadowColor='#81D4FA';ctx.shadowBlur=20;}
        if(p.stats.activePowers.berserk.active){ctx.shadowColor='#F44336';ctx.shadowBlur=20;}
    }
    if(!gameData.settings.performanceMode){ctx.fillStyle=`rgba(0,0,0,0.4)`;ctx.beginPath();ctx.ellipse(x+p.width/2,y+p.height,p.width*.7,p.height*.15,0,0,Math.PI*2);ctx.fill()}

    const bodyGradient = ctx.createLinearGradient(x, y + 20, x, y + p.height);
    bodyGradient.addColorStop(0, p.invincibilityTimer > 0 || (p?.stats?.activePowers?.aegis?.active) ? '#FFFFFF' : theme.text);
    bodyGradient.addColorStop(1, p.invincibilityTimer > 0 || (p?.stats?.activePowers?.aegis?.active) ? '#CCCCCC' : '#BDBDBD');
    
    ctx.fillStyle = p.invincibilityTimer > 0 ? 'rgba(236,240,241,0.5)' : bodyGradient;
    ctx.fillRect(x,y+20,p.width,p.height-20);
    
    const visorGradient = ctx.createLinearGradient(x-5, y+15, x+p.width+10, y+15);
    visorGradient.addColorStop(0, '#303F9F');
    visorGradient.addColorStop(0.5, '#5C6BC0');
    visorGradient.addColorStop(1, '#303F9F');
    
    ctx.fillStyle=visorGradient;ctx.fillRect(x-5,y+15,p.width+10,8);ctx.beginPath();ctx.moveTo(x+p.width/2,y-10);ctx.lineTo(x,y+18);ctx.lineTo(x+p.width,y+18);ctx.closePath();ctx.fill();
    ctx.restore();
}
function drawImp(e, theme){
    ctx.save();
    const bodyGradient = ctx.createLinearGradient(e.x, e.y, e.x, e.y + e.height);
    bodyGradient.addColorStop(0, theme.enemy);
    bodyGradient.addColorStop(1, '#6A0F0F'); // Darker shade of red
    ctx.fillStyle=bodyGradient;
    ctx.fillRect(e.x,e.y+e.height*0.2,e.width,e.height*0.8);
    ctx.beginPath();ctx.arc(e.x+e.width/2,e.y+e.height*0.2,e.width/2,Math.PI,2*Math.PI);ctx.fill();

    // Glowing eyes
    ctx.shadowColor = 'white'; ctx.shadowBlur = 5;
    ctx.fillStyle='#FFF';
    ctx.fillRect(e.x+e.width*0.2,e.y+e.height*0.4,e.width*0.2,e.height*0.2);
    ctx.fillRect(e.x+e.width*0.6,e.y+e.height*0.4,e.width*0.2,e.height*0.2);
    ctx.restore();
}
function drawWatcher(e, theme){
    ctx.save();
    const eyeColor='#E0F7FA';const wingColor='#90A4AE';ctx.fillStyle=wingColor;ctx.beginPath();ctx.moveTo(e.x,e.y+e.height/2);ctx.quadraticCurveTo(e.x-e.width*0.5,e.y,e.x+e.width/2,e.y+e.height/2);ctx.moveTo(e.x+e.width,e.y+e.height/2);ctx.quadraticCurveTo(e.x+e.width*1.5,e.y,e.x+e.width/2,e.y+e.height/2);ctx.fill();

    // Glowing Eye effect
    const eyeGradient = ctx.createRadialGradient(e.x+e.width/2, e.y+e.height/2, e.width/8, e.x+e.width/2, e.y+e.height/2, e.width/2);
    eyeGradient.addColorStop(0, '#FFFFFF');
    eyeGradient.addColorStop(0.3, eyeColor);
    eyeGradient.addColorStop(1, '#4DD0E1');
    
    ctx.shadowColor = eyeColor; ctx.shadowBlur = 10;
    ctx.fillStyle=eyeGradient;ctx.beginPath();ctx.arc(e.x+e.width/2,e.y+e.height/2,e.width/2,0,2*Math.PI);ctx.fill();
    ctx.shadowBlur = 0;

    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(e.x+e.width/2,e.y+e.height/2,e.width/4,0,2*Math.PI);ctx.fill();
    ctx.restore();
}
function drawBrute(e, theme){const stoneColor='#795548';ctx.fillStyle=stoneColor;ctx.fillRect(e.x,e.y,e.width,e.height);ctx.fillStyle='#5D4037';ctx.fillRect(e.x+e.width*0.1,e.y+e.height*0.1,e.width*0.8,e.height*0.8);ctx.fillStyle='#D7CCC8';ctx.fillRect(e.x+e.width*0.3,e.y+e.height*0.3,e.width*0.4,e.height*0.4);}
function drawSpecter(e, theme){ctx.globalAlpha=0.7;ctx.fillStyle='#E1BEE7';ctx.beginPath();ctx.arc(e.x+e.width/2,e.y+e.height/2,e.width/2,0,Math.PI*2);ctx.fill();ctx.fillStyle='#CE93D8';ctx.fillRect(e.x,e.y+e.height/2,e.width,e.height);ctx.globalAlpha=1;}
function drawJester(e, theme){const bodyColor='#FFEB3B';const hatColor='#D32F2F';ctx.fillStyle=bodyColor;ctx.beginPath();ctx.arc(e.x+e.width/2,e.y+e.height*0.7,e.width/2,0,Math.PI*2);ctx.fill();ctx.fillStyle=hatColor;ctx.beginPath();ctx.moveTo(e.x,e.y+e.height*0.3);ctx.lineTo(e.x+e.width,e.y+e.height*0.3);ctx.lineTo(e.x+e.width/2,e.y);ctx.closePath();ctx.fill();}
function drawBoss(e, theme){const color = e.isEnraged ? '#FF1744' : '#FF5722'; ctx.fillStyle=color;ctx.fillRect(e.x,e.y,e.width,e.height);ctx.fillStyle='#BF360C';ctx.fillRect(e.x+10,e.y+10,e.width-20,e.height-20);ctx.fillStyle='#FFF';ctx.fillRect(e.x+e.width*0.2,e.y+e.height*0.4,e.width*0.2,e.width*0.2);ctx.fillRect(e.x+e.width*0.6,e.y+e.height*0.4,e.width*0.2,e.width*0.2);}
function drawEnemy(e, theme){switch(e.type){case 'imp':drawImp(e,theme);break;case 'watcher':drawWatcher(e,theme);break;case 'brute':drawBrute(e,theme);break;case 'specter':drawSpecter(e,theme);break;case 'jester':drawJester(e,theme);break;case 'boss':drawBoss(e,theme);break;default:drawImp(e,theme);}}
function drawSpaceship(s){ctx.save();ctx.globalAlpha = 0.3; ctx.shadowColor = '#E3F2FD'; ctx.shadowBlur = 10;
    ctx.fillStyle=s.color1;
    ctx.beginPath();ctx.moveTo(s.x-s.w/2, s.y); ctx.lineTo(s.x+s.w/2, s.y); ctx.lineTo(s.x, s.y-s.h); ctx.closePath(); ctx.fill();
    ctx.fillStyle=s.color2;ctx.fillRect(s.x-s.w/4,s.y-s.h*0.7,s.w/2,s.h*0.6);
    const flameLength=s.h*0.5*random(0.8,1.2);ctx.fillStyle='#FFB74D';
    ctx.beginPath();ctx.moveTo(s.x-s.w/4,s.y);ctx.lineTo(s.x+s.w/4,s.y);ctx.lineTo(s.x,s.y+flameLength);ctx.closePath();ctx.fill();
ctx.restore();}
function drawCardIcon(cN,x,y,s){ctx.save();ctx.translate(x,y);ctx.fillStyle='white';ctx.strokeStyle='white';ctx.lineWidth=s/16;switch(cN){case'Catalyst':case'Catalyst+':case'Catalyst++':ctx.beginPath();ctx.moveTo(0,s);ctx.lineTo(s*0.5,0);ctx.lineTo(s,s);ctx.lineTo(s*0.75,s*0.5);ctx.lineTo(s*0.25,s*0.5);ctx.closePath();ctx.fill();break;case'Eyesight':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.4,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.2,0,Math.PI*2);ctx.fill();break;case'Growth':case'Renew':case'Last Stand':ctx.beginPath();ctx.moveTo(s*0.5,s*0.1);ctx.lineTo(s*0.1,s*0.4);ctx.lineTo(s*0.35,s*0.6);ctx.lineTo(s*0.35,s*0.9);ctx.lineTo(s*0.65,s*0.9);ctx.lineTo(s*0.65,s*0.6);ctx.lineTo(s*0.9,s*0.4);ctx.closePath();ctx.fill();ctx.fillRect(s*0.4,s*0.3,s*0.2,s*0.4);ctx.fillRect(s*0.3,s*0.4,s*0.4,s*0.2);break;case'Resonance':ctx.beginPath();for(let i=0;i<3;i++){ctx.arc(s*0.5,s*0.5,s*0.15+i*(s*0.1),-Math.PI*0.7,-Math.PI*0.3);ctx.stroke();}break;case'Swift':ctx.beginPath();ctx.moveTo(s*0.1,s*0.2);ctx.lineTo(s*0.5,s*0.2);ctx.lineTo(s*0.4,s*0.5);ctx.moveTo(s*0.4,s*0.5);ctx.lineTo(s*0.8,s*0.5);ctx.lineTo(s*0.7,s*0.8);ctx.stroke();break;case'Leech':case'Abyssal Hunger':ctx.beginPath();ctx.arc(s*0.5,s*0.8,s*0.2,0,Math.PI*2);ctx.fill();ctx.fillRect(s*0.4,0,s*0.2,s*0.6);ctx.beginPath();ctx.moveTo(s*0.5,s*0.6);ctx.lineTo(s*0.3,s*0.4);ctx.moveTo(s*0.5,s*0.6);ctx.lineTo(s*0.7,s*0.4);ctx.stroke();break;case'Precision':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.4,0,Math.PI*2);ctx.moveTo(s*0.5,0);ctx.lineTo(s*0.5,s);ctx.moveTo(0,s*0.5);ctx.lineTo(s,s*0.5);ctx.stroke();ctx.fillRect(s*0.4,s*0.4,s*0.2,s*0.2);break;case'Charge':ctx.beginPath();ctx.arc(s*0.3,s*0.3,s*0.1,0,Math.PI*2);ctx.moveTo(s*0.7,s*0.7);ctx.arc(s*0.7,s*0.7,s*0.2,0,Math.PI*2);ctx.stroke();ctx.moveTo(s*0.3,s*0.3);ctx.lineTo(s*0.7,s*0.7);ctx.stroke();break;case'Wound':ctx.beginPath();ctx.moveTo(s*0.1,s*0.9);ctx.quadraticCurveTo(s*0.5,s*0.1,s*0.9,s*0.9);ctx.stroke();ctx.fillStyle='red';ctx.beginPath();ctx.arc(s*0.5,s*0.6,s*0.1,0,Math.PI*2);ctx.fill();break;case'Thunderbolt':ctx.beginPath();ctx.moveTo(s*0.5,0);ctx.lineTo(s*0.3,s*0.4);ctx.lineTo(s*0.7,s*0.4);ctx.lineTo(s*0.5,s);ctx.lineTo(s*0.5,s*0.7);ctx.stroke();break;case'Will-O-Wisp':ctx.beginPath();ctx.arc(s*0.5,s*0.4,s*0.3,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.moveTo(s*0.3,s*0.8);ctx.lineTo(s*0.5,s*0.6);ctx.lineTo(s*0.7,s*0.8);ctx.stroke();break;case'Nova Pulse':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.1,0,Math.PI*2);ctx.fill();for(let i=0;i<8;i++){ctx.moveTo(s*0.5,s*0.5);ctx.lineTo(s*0.5+Math.cos(i*Math.PI/4)*s*0.4,s*0.5+Math.sin(i*Math.PI/4)*s*0.4);ctx.stroke();}break;case'Chain Lightning':ctx.beginPath();ctx.moveTo(s*0.1,s*0.2);ctx.lineTo(s*0.5,s*0.5);ctx.lineTo(s*0.1,s*0.8);ctx.moveTo(s*0.5,s*0.5);ctx.lineTo(s*0.9,s*0.2);ctx.stroke();break;case'Aegis Shield':ctx.beginPath();ctx.moveTo(s*0.5,0);ctx.lineTo(s*0.1,s*0.2);ctx.lineTo(s*0.1,s*0.6);ctx.quadraticCurveTo(s*0.5,s,s*0.9,s*0.6);ctx.lineTo(s*0.9,s*0.2);ctx.closePath();ctx.stroke();break;case'Appraisal':case'Gambler\'s Greed':ctx.fillRect(s*0.1,s*0.1,s*0.5,s*0.8);ctx.strokeRect(s*0.1,s*0.1,s*0.5,s*0.8);ctx.fillRect(s*0.4,0,s*0.5,s*0.8);ctx.strokeRect(s*0.4,0,s*0.5,s*0.8);break;case'Overheat':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.4,Math.PI*1.2,Math.PI*1.8);ctx.arc(s*0.5,s*0.5,s*0.4,Math.PI*0.2,Math.PI*0.8);ctx.stroke();ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.2,0,Math.PI*2);ctx.fill();break;case'Gush':ctx.beginPath();ctx.moveTo(s*0.2,s*0.8);ctx.quadraticCurveTo(s*0.5,s*0.4,s*0.8,s*0.8);ctx.moveTo(s*0.2,s*0.5);ctx.quadraticCurveTo(s*0.5,s*0.1,s*0.8,s*0.5);ctx.stroke();break;case'Immortal':case'Borrowed Time':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.4,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.moveTo(s*0.2,s*0.2);ctx.lineTo(s*0.8,s*0.8);ctx.moveTo(s*0.8,s*0.2);ctx.lineTo(s*0.2,s*0.8);ctx.stroke();break;case'Glass Cannon':case'Glass Cannon Supreme':ctx.fillRect(s*0.2,0,s*0.6,s);ctx.clearRect(s*0.3,s*0.1,s*0.4,s*0.8);break;case'Blood Pact':ctx.beginPath();ctx.arc(s*0.5,s*0.3,s*0.2,0,Math.PI*2);ctx.arc(s*0.3,s*0.7,s*0.2,0,Math.PI*2);ctx.arc(s*0.7,s*0.7,s*0.2,0,Math.PI*2);ctx.fillStyle='red';ctx.fill();break;case'Aegis Barrier':ctx.beginPath();ctx.moveTo(s*0.5,0);ctx.lineTo(s*0.1,s*0.2);ctx.lineTo(s*0.1,s*0.6);ctx.quadraticCurveTo(s*0.5,s,s*0.9,s*0.6);ctx.lineTo(s*0.9,s*0.2);ctx.closePath();ctx.stroke();ctx.fillRect(s*0.4,s*0.4,s*0.2,s*0.2);break;case'Chrono-Shift':ctx.beginPath();ctx.arc(s*0.5,s*0.5,s*0.4,0,Math.PI*2);ctx.stroke();ctx.fillRect(s*0.45,s*0.1,s*0.1,s*0.5);ctx.beginPath();ctx.moveTo(s*0.5,s*0.5);ctx.lineTo(s*0.8,s*0.5);ctx.stroke();break;case'Berserker\'s Rage':case'Chaotic Frenzy':ctx.beginPath();ctx.moveTo(s*0.1,s*0.1);ctx.lineTo(s*0.9,s*0.9);ctx.moveTo(s*0.1,s*0.9);ctx.lineTo(s*0.9,s*0.1);ctx.stroke();ctx.fillRect(s*0.4,s*0.4,s*0.2,s*0.2);break;default:ctx.fillText('?',s*0.5,s*0.5+s*0.1);break;}
ctx.restore()}

// --- CARD DEFINITIONS ---
const MAX_LEVEL = 5;
const UPGRADES=[{n:"Catalyst",d:"Damage +2.",r:'c',type:'passive',levelable:true,a:p=>p.stats.projectileDamage+=2,scaling:p=>p.stats.projectileDamage+=2},{n:"Eyesight",d:"Crit Chance +5%.",r:'c',type:'passive',levelable:true,a:p=>p.stats.critChance+=0.05,scaling:p=>p.stats.critChance+=0.05},{n:"Growth",d:"Max. HP +10.",r:'c',type:'passive',levelable:true,a:p=>{p.stats.maxHp+=10;if(p.stats.canHeal)p.hp+=10},scaling:p=>{p.stats.maxHp+=10;if(p.stats.canHeal)p.hp+=10}},{n:"Resonance",d:"Atk Speed +12%.",r:'c',type:'passive',levelable:true,a:p=>p.stats.attackSpeed*=0.88,scaling:p=>p.stats.attackSpeed*=0.92},{n:"Swift",d:"Move Speed +15%.",r:'c',type:'passive',levelable:true,a:p=>p.stats.speed*=1.15,scaling:p=>p.stats.speed*=1.15},{n:"Leech",d:"Life Steal 3%.",r:'u',type:'passive',levelable:true,a:p=>p.stats.lifesteal+=0.03,scaling:p=>p.stats.lifesteal+=0.03},{n:"Precision",d:"Crit Dmg +50%.",r:'u',type:'passive',levelable:true,a:p=>p.stats.critDamageMultiplier+=0.5,scaling:p=>p.stats.critDamageMultiplier+=0.5},{n:"Charge",d:"Projectile Size +20%.",r:'u',type:'passive',levelable:true,a:p=>p.stats.projectileSize*=1.2,scaling:p=>p.stats.projectileSize*=1.1},{n:"Wound",d:"Projectiles apply bleeding.",r:'r',l:"Bleed damage scales with level.",type:'passive',levelable:true,a:p=>p.stats.canBleed=true,scaling:p=>{}},{n:"Thunderbolt",d:"Calls 2 thunderbolts every 5s.",r:'r',l:"Level up to increase damage.",type:'passive',levelable:true,a:p=>p.stats.hasThunderbolt=true,scaling:p=>{}},{n:"Will-O-Wisp",d:"Summons a wisp familiar.",r:'r',l:"Wisp damage scales with level.",type:'passive',levelable:true,a:p=>p.stats.hasWisp=true,scaling:p=>{}},{n:"Nova Pulse",d:"Emits a damaging pulse every 4s.",r:'r',l:"Damage increases with level.",type:'passive',levelable:true,a:p=>p.stats.novaPulse.enabled=true,scaling:p=>p.stats.novaPulse.damage+=15},{n:"Chain Lightning",d:"Proj. have a 15% chance to chain.",r:'r',l:"Chance increases with level.",type:'passive',levelable:true,a:p=>p.stats.chainChance+=0.15,scaling:p=>p.stats.chainChance+=0.15},{n:"Aegis Shield",d:"A shield blocks one hit every 15s.",r:'l',l:"Cooldown decreases with level.",type:'passive',levelable:true,a:p=>p.stats.aegis.enabled=true,scaling:p=>p.stats.aegis.cooldown=Math.max(5000,p.stats.aegis.cooldown-2000)},{n:"Appraisal",d:"+1 card choice from now on.",r:'l',type:'passive',levelable:false,a:p=>p.stats.upgradeChoices++},{n:"Overheat",d:"Your body deals damage on contact.",r:'l',type:'passive',levelable:true,a:p=>p.stats.contactDamage+=20,scaling:p=>p.stats.contactDamage+=20},{n:"Renew",d:"Heal to Full HP.",r:'c',type:'passive',levelable:false,a:p=>{if(p.stats.canHeal)p.hp=p.stats.maxHp}},{n:"Gush",d:"+1 Jump (Max 2).",r:'u',type:'passive',levelable:false,a:p=>p.stats.maxJumps=Math.min(2,p.stats.maxJumps+1)},{n:"Immortal",d:"+1 Revive.",r:'l',type:'passive',levelable:false,a:p=>p.stats.revives++},{n:"Glass Cannon",d:"+100% Dmg, -50% Max HP.",r:'cursed',type:'passive',levelable:false,a:p=>{p.stats.damageMultiplier*=2;p.stats.maxHp=Math.ceil(p.stats.maxHp*0.5);p.hp=Math.min(p.hp,p.stats.maxHp)}},{n:"Blood Pact",d:"-25% Max HP for +40% Damage.",r:'cursed',type:'passive',levelable:false,a:p=>{p.stats.maxHp=Math.ceil(p.stats.maxHp*0.75);p.hp=Math.min(p.hp,p.stats.maxHp);p.stats.damageMultiplier+=0.4}},{n:"Aegis Barrier",d:"Become immune for 5s.",r:'l',type:'active',stateName:'aegis',duration:5000,cooldown:40000,levelable:false},{n:"Chrono-Shift",d:"Slow all enemies for 4s.",r:'l',type:'active',stateName:'chronoShift',duration:4000,cooldown:50000,levelable:false},{n:"Berserker's Rage",d:"Massive damage & atk speed for 8s.",r:'l',type:'active',stateName:'berserk',duration:8000,cooldown:60000,levelable:false},];
const PACTS = [{n:"Glass Cannon Supreme",d:"+500% Dmg. Your next shot is your last.",l:"Explodes you on use.",r:'pact', a:p=>{p.stats.damageMultiplier+=5;p.stats.hasOneShot=true;}},{n:"Borrowed Time",d:"Invincible for 30s. Enemies are permanently faster.",l:"All enemies +15% speed.",r:'pact', a:p=>{p.invincibilityTimer=30000;p.stats.globalEnemySpeedMod+=0.15;}},{n:"Gambler's Greed", d:"Permanently triple EXP gain.",l:"Lose 33% of your Max HP.", r:'pact', a:p=>{p.stats.expMultiplier=3;p.stats.maxHp=Math.ceil(p.stats.maxHp*0.67);p.hp=Math.min(p.hp,p.stats.maxHp)}},{n:"Chaotic Frenzy",d:"Triple attack speed. Shots are wild.",l:"Projectiles have random spread.",r:'pact',a:p=>{p.stats.attackSpeed/=3;p.stats.hasFrenzy=true;}},{n:"Last Stand", d:"Heal to full. Cannot heal anymore.",l:"HP is capped at current max.",r:'pact', a:p=>{p.hp=p.stats.maxHp; p.stats.canHeal=false;}},{n:"Abyssal Hunger",d:"Gain 5% lifesteal permanently.",l:"Lose 25% of current HP.",r:'pact', a:p=>{p.stats.lifesteal+=0.05; p.takeDamage(p.hp*0.25, false);}}];
let currentPactChoices=[];

// --- CLASSES ---
class Player { constructor() { this.width=32;this.height=48;this.x=canvas.width/2-this.width/2;this.y=canvas.height-this.height-100;this.velocity={x:0,y:0};this.jumpsLeft=0;this.level=1;this.exp=0;this.expToNextLevel=100;this.shootCooldown=0;this.invincibilityTimer=0;this.upgrades={};this.activeAbilities={f:null,g:null,j:null};
    this.stats={speed:5,jumpStrength:16,maxJumps:1,maxHp:100,projectileDamage:8,attackSpeed:500,critChance:0.05,critDamageMultiplier:1.5,lifesteal:0,projectileSize:6,invincibilityDuration:500,upgradeChoices:3,revives:0,contactDamage:0,damageMultiplier:1,expMultiplier:1,globalEnemySpeedMod:1,hasOneShot:false,hasFrenzy:false,canHeal:true,hasThunderbolt:false,thunderboltTimer:5e3,hasWisp:false,wisp:null,canBleed:false,chainChance:0,
    novaPulse:{enabled:false,timer:4000,damage:20},aegis:{enabled:false,active:true,timer:0,cooldown:15000},
    activePowers:{aegis:{active:false,timer:0,cooldownTimer:0},chronoShift:{active:false,timer:0,cooldownTimer:0},berserk:{active:false,timer:0,cooldownTimer:0}}};
    this.hp=this.stats.maxHp;this.regenTimer=5000;this.regenCooldown=5000;}
    draw(theme){
        drawPlayerSprite(this,theme);
        if(this.stats.aegis.enabled && this.stats.aegis.active){
            ctx.save();
            ctx.fillStyle = 'rgba(3, 169, 244, 0.2)';
            ctx.strokeStyle = '#03A9F4';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#81D4FA';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }
    }
    update(){this.velocity.x=0;if(keys.a.p)this.velocity.x=-this.stats.speed;if(keys.d.p)this.velocity.x=this.stats.speed;this.x+=this.velocity.x;this.y+=this.velocity.y;if(this.y+this.height+this.velocity.y<canvas.height){this.velocity.y+=GRAVITY}else{this.velocity.y=0}let onPlatform=false;terrain.blocks.forEach(p=>{if(this.y+this.height<=p.y&&this.y+this.height+this.velocity.y>=p.y&&this.x+this.width>p.x&&this.x<p.x+p.width){this.velocity.y=0;this.y=p.y-this.height;onPlatform=true}});if(onPlatform){this.jumpsLeft=this.stats.maxJumps}if(this.x<50)this.x=50;if(this.x+this.width>canvas.width-50)this.x=canvas.width-50-this.width;if(this.shootCooldown>0)this.shootCooldown-=16.67;if(this.invincibilityTimer>0)this.invincibilityTimer-=16.67;if(mouse.down&&this.shootCooldown<=0){this.shoot();this.shootCooldown=this.stats.attackSpeed}
    if(this.stats.canHeal){this.regenTimer-=16.67; if(this.regenTimer<=0){this.hp=Math.min(this.stats.maxHp,this.hp+1);this.regenTimer=this.regenCooldown;}}
    if(this.stats.hasThunderbolt){this.stats.thunderboltTimer-=16.67;if(this.stats.thunderboltTimer<=0){const dmg=50+(this.upgrades['Thunderbolt']?this.upgrades['Thunderbolt'].level*25:0);this.castThunderbolt(2,dmg);this.stats.thunderboltTimer=5e3}}if(this.stats.hasWisp&&!this.stats.wisp){this.stats.wisp=new Wisp(this)}if(this.stats.hasWisp&&this.stats.wisp){this.stats.wisp.update()}if(this.stats.novaPulse.enabled){this.stats.novaPulse.timer-=16.67;if(this.stats.novaPulse.timer<=0){enemies.forEach(e=>{if(Math.hypot(this.x-e.x,this.y-e.y)<200)e.takeDamage(this.stats.novaPulse.damage,false)});this.stats.novaPulse.timer=4000}}if(this.stats.aegis.enabled&&!this.stats.aegis.active){this.stats.aegis.timer-=16.67;if(this.stats.aegis.timer<=0)this.stats.aegis.active=true;}this.updateActivePowers();}
    updateActivePowers(){Object.values(this.activeAbilities).forEach(ability=>{if(!ability)return;const state=this.stats.activePowers[ability.stateName];if(state.cooldownTimer>0)state.cooldownTimer-=16.67;if(state.active){state.timer-=16.67;if(state.timer<=0){state.active=false;this.deactivatePower(ability);}}});}
    activatePower(key){const ability=this.activeAbilities[key];if(!ability)return;const powerState=this.stats.activePowers[ability.stateName];if(!powerState||powerState.cooldownTimer>0||powerState.active)return;playPowerUpSound();powerState.active=true;powerState.timer=ability.duration;powerState.cooldownTimer=ability.cooldown;
        if(ability.stateName==="berserk"){this.stats.damageMultiplier+=1;this.stats.attackSpeed/=2;}
    }
    deactivatePower(ability){if(ability.stateName==="berserk"){this.stats.damageMultiplier-=1;this.stats.attackSpeed*=2;}}
    jump(){if(this.jumpsLeft>0){playJumpSound();this.velocity.y=-this.stats.jumpStrength;this.jumpsLeft--}}
    shoot(){let angle=Math.atan2(mouse.y-(this.y+this.height/2),mouse.x-(this.x+this.width/2));if(this.stats.hasFrenzy)angle+=random(-0.5,0.5);let damage=this.stats.projectileDamage*this.stats.damageMultiplier;let isCrit=Math.random()<this.stats.critChance;if(isCrit){damage*=this.stats.critDamageMultiplier}playerProjectiles.push(new Projectile(this.x+this.width/2,this.y+this.height/2,Math.cos(angle)*15,Math.sin(angle)*15,this.stats.projectileSize,currentTheme.projectile,damage,isCrit));if(this.stats.hasOneShot){this.takeDamage(9999);}}
    castThunderbolt(count,dmg){if(enemies.length===0)return;const targets=[...enemies].sort(()=>0.5-Math.random()).slice(0,count);targets.forEach(enemy=>{enemy.takeDamage(dmg,true);particles.push(new Thunderbolt(enemy.x+enemy.width/2));});}
    takeDamage(amount, fromProjectile = true){
        if(this.invincibilityTimer>0||this.stats.activePowers.aegis.active)return;if(this.stats.aegis.enabled&&this.stats.aegis.active){this.stats.aegis.active=false;this.stats.aegis.timer=this.stats.aegis.cooldown;return}
        gameDifficulty==='nightmare'?playDamageSoundNightmare():playDamageSound();
        if (this.stats.canHeal || amount > 0) this.hp -= amount;
        this.invincibilityTimer=this.stats.invincibilityDuration;floatingTexts.push(new FloatingText(this.x,this.y,Math.round(amount),'#F44336'));if(this.hp<=0){if(this.stats.revives>0){this.stats.revives--;this.hp=this.stats.maxHp;enemies.forEach(e=>e.hp=0);floatingTexts.push(new FloatingText(this.x,this.y-30,'REVIVED!','gold'))}else{playDefeatSound();restartTimer = 5000;if(ytPlayer&&typeof ytPlayer.pauseVideo==='function')ytPlayer.pauseVideo();gameState = 'gameOver';}}}
    gainExp(amount){this.exp+=amount*this.stats.expMultiplier;if(this.exp>=this.expToNextLevel){this.exp-=this.expToNextLevel;this.expToNextLevel=Math.floor(this.expToNextLevel*1.65);this.level++;if(this.stats.canHeal)this.hp=this.stats.maxHp;levelColorIndex=(levelColorIndex+1)%THEMES.length;currentTheme=THEMES[levelColorIndex];generateBackground();
        if(this.level%5===0){gameState='pact';generatePactChoices();}else{gameState='levelUp';generateUpgradeChoices();}
    floatingTexts.push(new FloatingText(this.x,this.y-30,'LEVEL UP!','lime'));playLevelUpSound();}}
}
class Wisp{constructor(owner){this.owner=owner;this.x=0;this.y=0;this.angle=0;this.radius=70;this.shootCooldown=0;this.lockedTarget=null;}
    update(){
        if(this.lockedTarget && (this.lockedTarget.hp <= 0 || !enemies.includes(this.lockedTarget))){this.lockedTarget = null;}
        if(!this.lockedTarget && enemies.length > 0){this.lockedTarget=enemies.filter(e => e.type !== 'boss').sort((a,b)=>Math.hypot(this.x-a.x,this.y-a.y)-Math.hypot(this.x-b.x,this.y-b.y))[0] || enemies[0];}
        this.angle+=0.03;this.x=this.owner.x+this.owner.width/2+Math.cos(this.angle)*this.radius-5;this.y=this.owner.y+this.owner.height/2+Math.sin(this.angle)*this.radius-5;
        if(this.shootCooldown>0){this.shootCooldown-=16.67}
        if(this.shootCooldown<=0&&this.lockedTarget){
            const level=player.upgrades['Will-O-Wisp']?player.upgrades['Will-O-Wisp'].level:1;
            const dmg=(player.stats.projectileDamage/2+level*2)*player.stats.damageMultiplier;
            playerProjectiles.push(new HomingProjectile(this.x,this.y,this.lockedTarget,this.owner.stats.projectileSize*0.7,'#9C27B0',dmg));
            this.shootCooldown=this.owner.stats.attackSpeed*2;
        }
    }draw(){ctx.save();ctx.fillStyle='#9C27B0';ctx.shadowColor = '#E1BEE7';ctx.shadowBlur=15;ctx.beginPath();ctx.arc(this.x,this.y,8,0,Math.PI*2);ctx.fill();ctx.restore();}}
class Projectile{constructor(x,y,vx,vy,r,c,d,iC,bounces=1){this.x=x;this.y=y;this.velocity={x:vx,y:vy};this.radius=r;this.color=c;this.damage=d;this.isCrit=iC;this.bounces=bounces;this.hitEnemies=[]}
    draw(){
        ctx.save();
        ctx.shadowBlur = this.isCrit ? 20 : 10;
        ctx.shadowColor = this.color;

        ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fill();
        
        if(this.isCrit){
            ctx.strokeStyle='white';
            ctx.lineWidth=2;
            ctx.stroke()
        }
        
        // Inner core for more pop
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius * 0.4, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
    update(){this.x+=this.velocity.x;this.y+=this.velocity.y;if (!gameData.settings.performanceMode && Math.random() < 0.5) {particles.push(new Particle(this.x, this.y, 0, 0, this.radius * 0.5, this.color + '80', 10));}
}}
class HomingProjectile extends Projectile {
    constructor(x, y, target, r, c, d) { super(x, y, 0, 0, r, c, d, false); this.target = target; this.turnSpeed = 0.1; this.speed = 10; }
    update() {
        if (this.target && this.target.hp > 0) {
            const targetAngle = Math.atan2(this.target.y - this.y, this.target.x - this.x);
            let currentAngle = Math.atan2(this.velocity.y, this.velocity.x);
            let angleDiff = targetAngle - currentAngle;
            while(angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
            while(angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
            currentAngle += Math.sign(angleDiff) * Math.min(this.turnSpeed, Math.abs(angleDiff));
            this.velocity.x = Math.cos(currentAngle) * this.speed;
            this.velocity.y = Math.sin(currentAngle) * this.speed;
        }
        super.update();
    }
}
class Enemy{constructor(type,x,y){const diffMod=DIFFICULTY_MODS[gameDifficulty];const baseDifficulty=1+gameTime/6e4;this.type=type;this.x=x;this.y=y;
    switch(type){case'watcher':this.width=40;this.height=30;this.hp=Math.floor(12*baseDifficulty*diffMod.hp);this.damage=Math.floor(8*baseDifficulty*diffMod.dmg);this.speed=random(1.5,2.5)*diffMod.spd;this.expValue=Math.floor(30*baseDifficulty);break;case'brute':this.width=45;this.height=45;this.hp=Math.floor(50*baseDifficulty*diffMod.hp);this.damage=Math.floor(20*baseDifficulty*diffMod.dmg);this.speed=random(0.5,1)*diffMod.spd;this.expValue=Math.floor(50*baseDifficulty);break;case'specter':this.width=35;this.height=45;this.hp=Math.floor(25*baseDifficulty*diffMod.hp);this.damage=Math.floor(15*baseDifficulty*diffMod.dmg);this.speed=random(0.8,1.2)*diffMod.spd;this.expValue=Math.floor(40*baseDifficulty);break;case'jester':this.width=30;this.height=40;this.hp=Math.floor(20*baseDifficulty*diffMod.hp);this.damage=Math.floor(12*baseDifficulty*diffMod.dmg);this.speed=random(1,1.5)*diffMod.spd;this.expValue=Math.floor(45*baseDifficulty);this.jesterTimer=random(1000,2000);break;case'boss':this.width=100;this.height=100;this.hp=2000*baseDifficulty*diffMod.hp;this.damage=40*diffMod.dmg;this.speed=1.5*diffMod.spd;this.expValue=1e3;this.attackPattern=['multiShot','quake','meteor'];this.currentAttackIndex=0;this.attackTimer=5000;this.quakeWarningTimer=0;this.quakeActive=false;this.meteorTimers=[null,null,null];this.isEnraged=false;this.enrageHelperTimer=5000;break;case'imp':default:this.width=30;this.height=30;this.hp=Math.floor(15*baseDifficulty*diffMod.hp);this.damage=Math.floor(10*baseDifficulty*diffMod.dmg);this.speed=random(1,2)*diffMod.spd;this.expValue=Math.floor(25*baseDifficulty);break;}this.maxHp=this.hp;this.shootCooldown=random(1500,3e3);this.descendY=canvas.height*0.6-random(0,150);this.isDescending=true;this.bleedTimer=0;this.bleedDmg=0;this.originalSpeed=this.speed}
    draw(theme){drawEnemy(this,theme)}
    update(){let currentSpeed=this.originalSpeed*(player?player.stats.globalEnemySpeedMod:1);if(player && player.stats.activePowers.chronoShift.active){currentSpeed*=0.2;}if(this.bleedTimer>0){this.bleedTimer-=16.67;if(Math.random()<0.1)this.hp-=this.bleedDmg}
    if(this.isDescending){this.y+=currentSpeed;if((this.type!=='boss'&&this.y>this.descendY)||(this.type==='boss'&&this.y>100)){this.isDescending=false;}}
    else if(this.type==='boss'){this.bossUpdate();}
    else if(this.type==='jester'){this.jesterTimer-=16.67;if(this.jesterTimer<=0){this.x+=random(-50,50);this.y+=random(-50,50);this.jesterTimer=random(500,1500);}if(this.x<50)this.x=50;if(this.x+this.width>canvas.width-50)this.x=canvas.width-50-this.width;if(this.y<50)this.y=50;if(this.y+this.height>canvas.height-100)this.y=canvas.height-100-this.height;}
    else if(this.type==='specter'){const angle=Math.atan2(player.y-this.y,player.x-this.x);this.x+=Math.cos(angle)*currentSpeed;this.y+=Math.sin(angle)*currentSpeed;}
    else{const angle=Math.atan2(player.y-this.y,player.x-this.x);this.x+=Math.cos(angle)*currentSpeed*0.4;this.y+=Math.sin(angle)*currentSpeed*0.4}
    if(this.type!=='boss'){this.shootCooldown-=16.67;if(this.shootCooldown<=0){this.shoot();this.shootCooldown=random(3000,5000)/Math.sqrt(1+gameTime/6e4)}}
    if(player&&player.stats.contactDamage>0&&checkCollision(this,player)){this.takeDamage(player.stats.contactDamage*0.1,false)}}
    shoot(){let pSpeed=player.stats.activePowers.chronoShift.active?2:6;if(gameDifficulty==='nightmare')pSpeed*=1.2;const angle=Math.atan2(player.y+player.height/2-(this.y+this.height/2),player.x+player.width/2-(this.x+this.width/2));
    let color = this.type==='brute' ? '#795548' : this.type==='jester' ? '#FFEB3B' : currentTheme.enemy;
    let size = this.type==='brute' ? 10 : 6;
    const proj = new Projectile(this.x+this.width/2,this.y+this.height/2,Math.cos(angle)*pSpeed,Math.sin(angle)*pSpeed,size,color,this.damage,false);
    if(this.type==='jester'){ proj.split=true; proj.splitTimer=1000; }
    enemyProjectiles.push(proj);}
    bossUpdate(){this.attackTimer-=16.67;if(this.hp/this.maxHp<0.35&&!this.isEnraged){this.isEnraged=true;this.attackTimer=1500;}if(this.isEnraged){this.enrageHelperTimer-=16.67;if(this.enrageHelperTimer<=0){enemies.push(new Enemy('imp',this.x+this.width/2,-50));this.enrageHelperTimer=5000;}}
    if(this.attackTimer<=0){const nextAttack=this.attackPattern[this.currentAttackIndex];switch(nextAttack){case 'multiShot':for(let i=-2;i<=2;i++){const angle=Math.atan2(player.y+player.height/2-(this.y+this.height/2),player.x+player.width/2-(this.x+this.width/2));enemyProjectiles.push(new Projectile(this.x+this.width/2,this.y+this.height/2,Math.cos(angle+i*0.2)*5,Math.sin(angle+i*0.2)*5,10,'#FF5722',this.damage,false))} break;case 'quake':this.quakeWarningTimer=1000;playQuakeSound();break;case 'meteor':for(let i=0;i<3;i++)setTimeout(()=>{if(this.hp>0)this.meteorTimers[i]=new Meteor()},i*300);break;}this.currentAttackIndex=(this.currentAttackIndex+1)%this.attackPattern.length;this.attackTimer=this.isEnraged?2800:5000;}
    if(this.quakeWarningTimer>0){this.quakeWarningTimer-=16.67;if(this.quakeWarningTimer<=0){screenShake={active:true,magnitude:10,duration:200};if(checkCollision(player,{x:0,y:canvas.height-160,width:canvas.width,height:160}))player.takeDamage(this.damage*0.5)}}
    this.meteorTimers.forEach((m,i)=>{if(m){m.update();if(m.dead)this.meteorTimers[i]=null;}});}
    takeDamage(amount,fromProjectile){this.hp-=amount;floatingTexts.push(new FloatingText(this.x,this.y,Math.round(amount),'white'));if(fromProjectile&&player.stats.canHeal&&player.stats.lifesteal>0){player.hp=Math.min(player.stats.maxHp,player.hp+amount*player.stats.lifesteal)}if(fromProjectile&&player.stats.canBleed){const level=player.upgrades['Wound']?player.upgrades['Wound'].level:1;this.bleedTimer=2e3;this.bleedDmg+=(amount*0.1)*level}}}
class Particle{constructor(x,y,vx,vy,s,c,l){this.x=x;this.y=y;this.v={x:vx,y:vy};this.s=s;this.c=c;this.l=l;this.il=l}draw(){ctx.globalAlpha=this.l/this.il;ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,this.s,this.s);ctx.globalAlpha=1}update(){this.x+=this.v.x;this.y+=this.v.y;this.l--}}
class Thunderbolt extends Particle{constructor(x){super(x,0,0,0,0,'y',30);this.seg=20;this.path=[{x:x,y:0}];for(let i=1;i<this.seg;i++){this.path.push({x:this.path[i-1].x+random(-20,20),y:canvas.height/this.seg*i})}}draw(){ctx.save();ctx.globalAlpha=this.l/this.il;ctx.shadowColor = '#FDE047';ctx.shadowBlur = 15;ctx.strokeStyle='#FBC02D';ctx.lineWidth=random(3,6);ctx.beginPath();ctx.moveTo(this.path[0].x,this.path[0].y);for(let i=1;i<this.seg;i++){ctx.lineTo(this.path[i].x,this.path[i].y)}ctx.stroke();ctx.restore();}}
class FloatingText{constructor(x,y,t,c){this.x=x;this.y=y;this.text=t;this.color=c;this.lifespan=60;this.opacity=1}update(){this.y-=1;this.lifespan--;this.opacity=this.lifespan/60}draw(){ctx.globalAlpha=this.opacity;ctx.fillStyle=this.color;ctx.font=`16px ${FONT_PRIMARY}`;ctx.shadowColor = 'black'; ctx.shadowBlur = 4;ctx.fillText(this.text,this.x,this.y);ctx.shadowBlur = 0;ctx.globalAlpha=1}}
class BackgroundParticle {constructor() {this.x = Math.random() * canvas.width;this.y = Math.random() * canvas.height;this.size = random(1, 3);this.speedY = random(0.1, 0.5);this.opacity = random(0.2, 0.8);}update() {this.y -= this.speedY;if (this.y < 0) {this.y = canvas.height;this.x = Math.random() * canvas.width;}}draw() {ctx.fillStyle = `rgba(255, 255, 224, ${this.opacity})`;ctx.beginPath();ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);ctx.fill();}}
class Spaceship{constructor(){this.w=random(20,40);this.h=this.w*1.5;this.speed=random(1,3);const edge=Math.floor(random(0,3));if(edge===0){this.x=-this.w;this.y=random(0,canvas.height*0.6);this.angle=random(-0.3,0.3);}else if(edge===1){this.x=canvas.width+this.w;this.y=random(0,canvas.height*0.6);this.angle=Math.PI+random(-0.3,0.3);}else{this.x=random(0,canvas.width);this.y=-this.h;this.angle=Math.PI/2+random(-0.3,0.3);}this.color1='#B0BEC5';this.color2='#78909C';}
update(){this.x+=Math.cos(this.angle)*this.speed;this.y+=Math.sin(this.angle)*this.speed;if(this.x<-100||this.x>canvas.width+100||this.y>canvas.height+100){this.dead=true;}}draw(){drawSpaceship(this);}}
class Meteor{constructor(){this.targetX=player.x;this.x=this.targetX;this.y=-50;this.radius=20;this.speed=8;this.dead=false;this.visible=false;this.followTimer=2000;}
update(){if(this.followTimer>0){this.targetX=player.x;this.x=this.targetX;this.followTimer-=16.67;}else{this.visible=true;this.y+=this.speed;}if(this.visible && checkCollision({x:this.x-this.radius,y:this.y-this.radius,width:this.radius*2,height:this.radius*2},player)){player.takeDamage(40);this.dead=true;}if(this.y>canvas.height)this.dead=true;}
draw(){if(this.visible){ctx.save();ctx.fillStyle='orange';ctx.shadowColor='red';ctx.shadowBlur=20;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);ctx.fill();ctx.restore();}}}
// --- UTILITIES ---
function random(min,max){return Math.random()*(max-min)+min}
function checkCollision(r1,r2){return r1.x<r2.x+r2.width&&r1.x+r1.width>r2.x&&r1.y<r2.y+r2.height&&r1.y+r1.height>r2.y}

// --- GAME LOGIC ---
const DIFFICULTY_MODS = {easy:{hp:0.7,dmg:0.8,spd:0.9,spawnRate:1.2},medium:{hp:1.0,dmg:1.0,spd:1.0,spawnRate:1.0},hard:{hp:1.5,dmg:1.2,spd:1.1,spawnRate:0.8},nightmare:{hp:3.0,dmg:2.0,spd:1.2,spawnRate:0.5}};
function createWorld(){terrain={blocks:[]};const T_W=48;const map=[" "," "," "," "," ","      ####                ","                          ","                 ####     ","                          ","  ##            ##        ","                          ","         ####             ","                          ","                          "," ######################## ","##########################"];for(let r=0;r<map.length;r++){for(let c=0;c<map[r].length;c++){if(map[r][c]==='#'){terrain.blocks.push({x:c*T_W,y:r*32+32*5,width:T_W,height:32})}}}}
let enemySpawnTimer=12e3;
function spawnEnemies(){if(bossIsActive)return;enemySpawnTimer-=16.67;if(enemySpawnTimer<=0){const diffMod=DIFFICULTY_MODS[gameDifficulty];const difficulty=1+gameTime/6e4;const numToSpawn=Math.floor(random(0.7,1.3)*Math.sqrt(difficulty));let spawnPool=['imp','imp','imp','watcher'];if(gameTime>45000)spawnPool.push('brute');if(gameTime>90000)spawnPool.push('specter');if(gameTime>120000)spawnPool.push('jester');for(let i=0;i<numToSpawn;i++){const type=spawnPool[Math.floor(Math.random()*spawnPool.length)];enemies.push(new Enemy(type,random(100,canvas.width-100),-50))}enemySpawnTimer=Math.max(2e3,(12e3/difficulty)*diffMod.spawnRate)}}
function spawnSpaceship(){spaceshipSpawnTimer-=16.67;if(spaceshipSpawnTimer<=0&&backgroundSpaceships.length<3){backgroundSpaceships.push(new Spaceship());spaceshipSpawnTimer=random(3000,8000);}}
function generateUpgradeChoices(){currentUpgradeChoices=[];const pool=[];UPGRADES.forEach(u=>{if(u.type==='active'){const assigned=Object.values(player.activeAbilities).some(ab=>ab&&ab.n===u.n);if(assigned)return;}if(u.type==='active'&&(!player.activeAbilities.f||!player.activeAbilities.g||!player.activeAbilities.j)===false)return;const pUpgrade=player.upgrades[u.n];if(!u.levelable&&pUpgrade)return;if(pUpgrade&&pUpgrade.level>=MAX_LEVEL)return;let w=0;switch(u.r){case'c':w=10;break;case'u':w=6;break;case'r':w=3;break;case'l':w=1;break;case'cursed':w=1;break}if(u.type==='active')w=2;for(let i=0;i<w;i++)pool.push(u)});for(let i=0;i<player.stats.upgradeChoices;i++){if(pool.length===0)break;const choice=pool.splice(Math.floor(Math.random()*pool.length),1)[0];currentUpgradeChoices.push(choice)}}
function generatePactChoices(){currentPactChoices=[];const pool=[...PACTS];for(let i=0;i<2;i++){if(pool.length===0)break;const choice=pool.splice(Math.floor(Math.random()*pool.length),1)[0];currentPactChoices.push(choice);}}
function handleCollisions(){
    // *** BUG FIX ***: Switched from forEach to a reverse for-loop.
    // This prevents skipping elements when removing an item (via splice) from the array during iteration.
    for (let projIndex = playerProjectiles.length - 1; projIndex >= 0; projIndex--) {
        const proj = playerProjectiles[projIndex];
        let projectileRemoved = false;
        
        for(let i = enemies.length - 1; i >= 0; i--){
            const enemy = enemies[i];
            if (proj.hitEnemies.includes(enemy.x+','+enemy.y)) continue; 

            if (checkCollision({x:proj.x-proj.radius,y:proj.y-proj.radius,width:proj.radius*2,height:proj.radius*2},enemy)) {
                gameDifficulty==='nightmare' ? playHitSoundNightmare() : playHitSound();
                enemy.takeDamage(proj.damage,true);
                proj.hitEnemies.push(enemy.x+','+enemy.y);

                if(enemy.hp<=0){
                    if(enemy.type==='boss')bossIsActive=false;
                    gameDifficulty==='nightmare'?playKillSoundNightmare():playKillSound();
                    if(!gameData.settings.performanceMode){
                        for(let p=0;p<15;p++){ // More particles on kill
                            particles.push(new Particle(enemy.x+enemy.width/2,enemy.y+enemy.height/2,random(-3,3),random(-3,3),random(2,5),currentTheme.highlight,random(30,60)))
                        }
                    }
                    player.gainExp(enemy.expValue);
                    score+=enemy.expValue;
                    enemies.splice(i,1);
                }

                let shouldChain = Math.random() < player.stats.chainChance && proj.bounces > 0;
                let nextTarget = null;
                if(shouldChain){
                    const otherEnemies=enemies.filter(e =>!proj.hitEnemies.includes(e.x+','+e.y)).sort((a,b)=>Math.hypot(proj.x-a.x,proj.y-a.y)-Math.hypot(proj.x-b.x,proj.y-b.y));
                    if(otherEnemies.length>0) nextTarget = otherEnemies[0];
                }
                
                if(nextTarget){
                    const angle=Math.atan2(nextTarget.y-proj.y,nextTarget.x-proj.x);
                    proj.velocity.x=Math.cos(angle)*15;
                    proj.velocity.y=Math.sin(angle)*15;
                    proj.bounces--;
                } else {
                    playerProjectiles.splice(projIndex, 1);
                    projectileRemoved = true;
                }
                break; // Exit the inner enemy loop once a collision is handled for this projectile
            }
        }
        if (projectileRemoved) continue; // Move to the next projectile if this one was removed
    }

    enemyProjectiles.forEach((proj,index)=>{if(checkCollision({x:proj.x,y:proj.y,width:proj.radius,height:proj.radius},player)){player.takeDamage(proj.damage);enemyProjectiles.splice(index,1)}
    if(proj.split){if(!checkCollision({x:proj.x,y:proj.y,width:proj.radius*2,height:proj.radius*2},{x:0,y:0,width:canvas.width,height:canvas.height}) || proj.splitTimer<=0){for(let i=0;i<3;i++){enemyProjectiles.push(new Projectile(proj.x,proj.y,random(-5,5),random(-5,5),4,proj.color,proj.damage/2,false))}enemyProjectiles.splice(index,1)}else if(proj.splitTimer)proj.splitTimer-=16.67;}})}

// --- MENU & UI DRAWING ---
let menuButtons=[],settingsButtons=[],pauseButtons=[],bindsButtons=[],difficultyButtons=[];
function setupMenus(){menuButtons=[{x:canvas.width/2-100,y:480,w:200,h:50,text:'Start',action:()=>{playClickSound();menuState='difficulty';}},{x:canvas.width/2-100,y:540,w:200,h:50,text:'Settings',action:()=>{playClickSound();menuState='settings'}},{x:canvas.width/2-100,y:600,w:200,h:50,text:'Binds',action:()=>{playClickSound();menuState='binds'}}];difficultyButtons=[{x:canvas.width/2-100,y:300,w:200,h:50,text:'Easy',action:()=>{playClickSound();gameDifficulty='easy';initGame();gameState='playing';}},{x:canvas.width/2-100,y:360,w:200,h:50,text:'Medium',action:()=>{playClickSound();gameDifficulty='medium';initGame();gameState='playing';}},{x:canvas.width/2-100,y:420,w:200,h:50,text:'Hard',action:()=>{playClickSound();gameDifficulty='hard';initGame();gameState='playing';}},{x:canvas.width/2-100,y:480,w:200,h:50,text:'Nightmare',action:()=>{playClickSound();gameDifficulty='nightmare';initGame();gameState='playing';}}];pauseButtons=[{x:canvas.width/2-100,y:300,w:200,h:50,text:'Resume',action:()=>{playClickSound();gameState='playing'; if(ytPlayer) ytPlayer.playVideo();}},{x:canvas.width/2-100,y:360,w:200,h:50,text:'Quit to Menu',action:()=>{playClickSound();gameState='menu';menuState='main';}}];settingsButtons=[{x:canvas.width/2-150,y:300,w:300,h:50,text:'Quality',type:'quality',action:()=>{playClickSound();if(gameData.settings.performanceMode){gameData.settings.performanceMode=false;saveGameData();generateBackground()}}},{x:canvas.width/2-150,y:360,w:300,h:50,text:'Performance',type:'performance',action:()=>{playClickSound();if(!gameData.settings.performanceMode){gameData.settings.performanceMode=true;saveGameData();generateBackground()}}},{x:canvas.width/2-100,y:550,w:200,h:50,text:'Back',action:()=>{playClickSound();menuState='main'}}];bindsButtons=[{x:canvas.width/2-100,y:550,w:200,h:50,text:'Back',action:()=>{playClickSound();menuState='main'}}]
}
function drawIntro(){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.textAlign='center';ctx.fillStyle='#FFF';ctx.font=`20px ${FONT_PRIMARY}`;const lines = ["Ol√° argent- Andr√©! Espero que voc√™ goste","do meu jogo que eu fiz 100% com IA,","eu achei q ficou legal üëç‚ù§Ô∏è","","(Eu recomendo tirar um pouco o zoom da p√°gina!)"];lines.forEach((l, i) => {ctx.fillText(l, canvas.width / 2, canvas.height / 2 - 80 + (i * 40));});if(introTimer<=0){ctx.font=`16px ${FONT_PRIMARY}`;ctx.fillText("Clique para jogar",canvas.width/2,canvas.height/2+120);}}
function drawMenu(){
    ctx.drawImage(skyCanvas,0,0);
    if(!gameData.settings.performanceMode){backgroundSpaceships.forEach(s=>s.draw()); backgroundParticles.forEach(p=>p.draw());}
    ctx.drawImage(terrainCanvas,0,0);
    
    ctx.textAlign='center';
    if(menuState==='main'){ctx.save();ctx.shadowColor='black';ctx.shadowBlur=10;ctx.fillStyle=currentTheme.highlight;ctx.font=`54px ${FONT_PRIMARY}`;ctx.fillText("Seraph's Lag Stand",canvas.width/2,150);ctx.fillStyle=currentTheme.text;ctx.font=`12px ${FONT_PRIMARY}`;ctx.fillText("(sim, eu pensei nesse nome)",canvas.width/2,180);ctx.restore();drawPlayerSprite({x:canvas.width/2-16,y:350,width:32,height:48,invincibilityTimer:0},currentTheme);menuButtons.forEach(btn=>drawButton(btn));}
    else if(menuState==='difficulty'){drawDifficultyScreen();}
    else if(menuState==='settings'){ctx.fillStyle=currentTheme.highlight;ctx.font=`40px ${FONT_PRIMARY}`;ctx.fillText("Settings",canvas.width/2,150);settingsButtons.forEach(btn=>drawButton(btn));ctx.fillStyle=currentTheme.text;ctx.font=`16px ${FONT_PRIMARY}`;ctx.fillText(`Volume: ${gameData.settings.volume}%`,canvas.width/2,440);const s={x:canvas.width/2-150,y:460,w:300,h:20};ctx.fillStyle='#555';ctx.fillRect(s.x,s.y,s.w,s.h);ctx.fillStyle=currentTheme.highlight;ctx.fillRect(s.x,s.y,s.w*(gameData.settings.volume/100),s.h);}
    else if(menuState==='binds'){ctx.fillStyle=currentTheme.highlight;ctx.font=`40px ${FONT_PRIMARY}`;ctx.fillText("Key Binds",canvas.width/2,150);ctx.fillStyle=currentTheme.text;ctx.font=`16px ${FONT_PRIMARY}`;const binds=["A / D - Move Left / Right","Space - Jump","Mouse - Aim & Shoot","F - Active Ability 1","G - Active Ability 2","J - Active Ability 3","ESC - Pause Game"];binds.forEach((b,i)=>{ctx.fillText(b,canvas.width/2,250+i*40);});bindsButtons.forEach(btn=>drawButton(btn));}
}
function drawDifficultyScreen(){ctx.textAlign='center';ctx.fillStyle=currentTheme.highlight;ctx.font=`40px ${FONT_PRIMARY}`;ctx.fillText("Choose Difficulty",canvas.width/2,150);difficultyButtons.forEach(btn=>drawButton(btn));}
function drawPauseScreen(){drawPlaying();ctx.fillStyle='#00000099';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.textAlign='center';ctx.fillStyle=currentTheme.highlight;ctx.font=`60px ${FONT_PRIMARY}`;ctx.fillText("Paused",canvas.width/2,150);pauseButtons.forEach(btn=>drawButton(btn));}
function drawButton(btn){
    ctx.save();
    const h=mouse.x>btn.x&&mouse.x<btn.x+btn.w&&mouse.y>btn.y&&mouse.y<btn.y+btn.h;let a=false;if(btn.type==='quality'&&!gameData.settings.performanceMode)a=true;if(btn.type==='performance'&&gameData.settings.performanceMode)a=true;
    if (h || a) { ctx.shadowColor = currentTheme.highlight; ctx.shadowBlur = 15; }
    ctx.strokeStyle=h||a?currentTheme.highlight:currentTheme.text;ctx.lineWidth=3;ctx.strokeRect(btn.x,btn.y,btn.w,btn.h);ctx.fillStyle=h||a?currentTheme.highlight:currentTheme.text;ctx.textAlign='center';ctx.font=`16px ${FONT_PRIMARY}`;ctx.fillText(btn.text,btn.x+btn.w/2,btn.y+btn.h/2+8);
    ctx.restore();
}
function drawPlayingUI(){const hpBar={x:20,y:20,w:300,h:25};ctx.fillStyle='#00000080';ctx.fillRect(hpBar.x,hpBar.y,hpBar.w,hpBar.h);ctx.fillStyle=currentTheme.hp;ctx.fillRect(hpBar.x,hpBar.y,player.hp/player.stats.maxHp*hpBar.w,hpBar.h);ctx.fillStyle=currentTheme.text;ctx.textAlign='center';ctx.font=`14px ${FONT_PRIMARY}`;ctx.shadowColor='black';ctx.shadowBlur=5;
ctx.fillText(`${Math.ceil(player.hp || 0)}/${player.stats.maxHp}`,hpBar.x+hpBar.w/2,hpBar.y+18);const xpBar={x:20,y:50,w:200,h:15};ctx.fillStyle='#00000080';ctx.fillRect(xpBar.x,xpBar.y,xpBar.w,xpBar.h);ctx.fillStyle=currentTheme.xp;ctx.fillRect(xpBar.x,xpBar.y,player.exp/player.expToNextLevel*xpBar.w,xpBar.h);ctx.fillText(`LVL ${player.level}`,xpBar.x+xpBar.w/2,xpBar.y+12);ctx.textAlign='right';const min=Math.floor(gameTime/6e4);const sec=Math.floor(gameTime%6e4/1e3).toString().padStart(2,'0');ctx.fillText(`${min}:${sec}`,canvas.width-30,40);const nBT=18e4-gameTime%18e4;const bM=Math.floor(nBT/6e4);const bS=Math.floor(nBT%6e4/1e3).toString().padStart(2,'0');if(!bossIsActive)ctx.fillText(`Boss:${bM}:${bS}`,canvas.width/2,40);ctx.shadowBlur=0;ctx.textAlign='left';drawActiveAbilityUI();}
function drawActiveAbilityUI(){let yOffset=0;['f','g','j'].forEach(key=>{const ability=player.activeAbilities[key];if(!ability)return;const s=50,p=10;const x=canvas.width-s-p,y=canvas.height-s-p-yOffset;const powerState=player.stats.activePowers[ability.stateName];ctx.fillStyle='#21212180';ctx.fillRect(x,y,s,s);ctx.strokeStyle='#FFF';ctx.lineWidth=2;ctx.strokeRect(x,y,s,s);drawCardIcon(ability.n,x+s*0.1,y+s*0.1,s*0.8);ctx.fillStyle='#FFF';ctx.font=`bold ${s*0.3}px ${FONT_PRIMARY}`;ctx.textAlign='left';ctx.fillText(key.toUpperCase(),x+p/2,y+s-p/2);
    if(powerState.active){const ratio=powerState.timer/ability.duration;const barHeight=5;ctx.fillStyle='#76FF03';ctx.fillRect(x,y+s-barHeight,s*ratio,barHeight);}
    else if(powerState.cooldownTimer>0){ctx.fillStyle='#000000A0';ctx.fillRect(x,y,s,s);const secondsLeft=Math.ceil(powerState.cooldownTimer/1000);ctx.font=`bold ${s*0.6}px ${FONT_PRIMARY}`;ctx.textAlign='center';ctx.fillStyle='#FFF';ctx.fillText(secondsLeft,x+s/2,y+s/2+(s*0.2));}
yOffset+=s+p;});}
function drawPactScreen() {drawPlaying();ctx.fillStyle = '#000000D0';ctx.fillRect(0, 0, canvas.width, canvas.height);ctx.textAlign='center';ctx.font=`40px ${FONT_PRIMARY}`;ctx.fillStyle='#D32F2F';ctx.shadowColor='black';ctx.shadowBlur=10;ctx.fillText("A PACT IS OFFERED",canvas.width/2,150);ctx.shadowBlur=0;const cardW = 280, cardH = 350, gap = 50;const totalW = 2 * cardW + gap;const sX = (canvas.width - totalW) / 2;const y = canvas.height / 2 - cardH / 2;currentPactChoices.forEach((card, index) => {const x = sX + index * (cardW + gap);const isH = mouse.x > x && mouse.x < x + cardW && mouse.y > y && mouse.y < y + cardH;const grad = ctx.createLinearGradient(x, y, x, y + cardH);grad.addColorStop(0, '#420b0b');grad.addColorStop(1, '#1A0000');ctx.fillStyle = grad; ctx.fillRect(x, y, cardW, cardH);ctx.strokeStyle = isH ? '#FF1744' : '#E53935';ctx.lineWidth = 4;ctx.strokeRect(x, y, cardW, cardH);ctx.fillStyle = '#FF8A80';ctx.font = `bold 18px ${FONT_PRIMARY}`;ctx.fillText(card.n, x + cardW / 2, y + 50);drawCardIcon(card.n, x + cardW / 2 - 40, y + 80, 80);ctx.fillStyle = '#FFCDD2';ctx.font = `14px ${FONT_PRIMARY}`;const dWords = card.d.split(' ');let line = '', tY = y + 200;for (let n = 0; n < dWords.length; n++) {let tL = line + dWords[n] + ' ';if (ctx.measureText(tL).width > cardW - 40 && n > 0) {ctx.fillText(line, x + cardW / 2, tY);line = dWords[n] + ' ';tY += 25;} else {line = tL;}}ctx.fillText(line, x + cardW / 2, tY);if (card.l) {ctx.fillStyle = '#E57373';ctx.font = `italic 11px ${FONT_PRIMARY}`;tY += 40;const lWords = card.l.split(' ');line = '';for (let n = 0; n < lWords.length; n++) {let tL = line + lWords[n] + ' ';if (ctx.measureText(tL).width > cardW - 40 && n > 0) {ctx.fillText(line, x + cardW / 2, tY);line = lWords[n] + ' ';tY += 18;} else {line = tL;}}ctx.fillText(line, x + cardW / 2, tY);}})}
function drawLevelUpScreen(){drawPlaying();ctx.fillStyle='#000000D0';ctx.fillRect(0,0,canvas.width,canvas.height);const cW=220,cH=300,gap=30;const tW=currentUpgradeChoices.length*cW+(currentUpgradeChoices.length-1)*gap;const sX=(canvas.width-tW)/2;const y=canvas.height/2-cH/2;currentUpgradeChoices.forEach((card,index)=>{const x=sX+index*(cW+gap);const isH=mouse.x>x&&mouse.x<x+cW&&mouse.y>y&&mouse.y<y+cH;let rC='#FFFFFF', gradColors=['#333333','#111111'];if(card.r==='u'){rC='#64B5F6';gradColors=['#1a3d5b','#0e2030'];}if(card.r==='r'){rC='#BA68C8';gradColors=['#4d2353','#240f27'];}if(card.r==='l'){rC='#FFD54F';gradColors=['#68551b','#312708'];}if(card.r==='cursed'){rC='#E57373';gradColors=['#5f2828','#2c1010'];}
    const grad=ctx.createLinearGradient(x,y,x,y+cH);grad.addColorStop(0,gradColors[0]);grad.addColorStop(1,gradColors[1]);ctx.fillStyle=grad;ctx.fillRect(x,y,cW,cH);ctx.strokeStyle=isH?'#76FF03':rC;ctx.lineWidth=4;ctx.strokeRect(x,y,cW,cH);ctx.textAlign='center';ctx.fillStyle=rC;ctx.font=`bold 18px ${FONT_PRIMARY}`;ctx.fillText(card.n,x+cW/2,y+40);const pUpgrade=player.upgrades[card.n];if(pUpgrade){ctx.font=`12px ${FONT_PRIMARY}`;ctx.fillStyle='yellow';ctx.fillText(`Level: ${pUpgrade.level}`,x+cW/2,y+65)}drawCardIcon(card.n,x+cW/2-40,y+80,80);ctx.fillStyle='#FFFFFF';ctx.font=`12px ${FONT_PRIMARY}`;const words=card.d.split(' ');let line='',tY=y+190;for(let n=0;n<words.length;n++){let tL=line+words[n]+' ';if(ctx.measureText(tL).width>cW-40&&n>0){ctx.fillText(line,x+cW/2,tY);line=words[n]+' ';tY+=20}else{line=tL}}ctx.fillText(line,x+cW/2,tY);if(card.l){ctx.fillStyle='#9E9E9E';ctx.font=`italic 10px ${FONT_PRIMARY}`;tY+=25;const lWords=card.l.split(' ');line='';for(let n=0;n<lWords.length;n++){let tL=line+lWords[n]+' ';if(ctx.measureText(tL).width>cW-40&&n>0){ctx.fillText(line,x+cW/2,tY);line=lWords[n]+' ';tY+=15}else{line=tL}}ctx.fillText(line,x+cW/2,tY)}})}
function drawGameOverScreen(){ctx.drawImage(skyCanvas,0,0);if(!gameData.settings.performanceMode)backgroundParticles.forEach(p=>p.draw());ctx.drawImage(terrainCanvas,0,0);enemies.forEach(e=>e.draw(currentTheme));playerProjectiles.forEach(p=>p.draw());enemyProjectiles.forEach(p=>p.draw());particles.forEach(p=>p.draw());floatingTexts.forEach(ft=>ft.draw());ctx.fillStyle='#000000B0';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.save();ctx.textAlign='center';ctx.fillStyle='#D32F2F';ctx.font=`80px ${FONT_PRIMARY}`;ctx.shadowColor='black';ctx.shadowBlur=15;ctx.fillText('YOU DIED',canvas.width/2,canvas.height/2-50);
    const min=Math.floor(gameTime/6e4);const sec=Math.floor(gameTime%6e4/1e3).toString().padStart(2,'0');
    ctx.fillStyle=currentTheme.text;ctx.font=`18px ${FONT_PRIMARY}`;ctx.fillText(`Run Time: ${min}:${sec}`,canvas.width/2,canvas.height/2+20);
    ctx.font=`24px ${FONT_PRIMARY}`;if(restartTimer>0){ctx.fillText(`Try again in ${Math.ceil(restartTimer/1000)}`, canvas.width/2, canvas.height/2 + 70);} else {ctx.font=`18px ${FONT_PRIMARY}`;ctx.fillText('Click anywhere to restart', canvas.width/2, canvas.height/2 + 120);}ctx.restore();}

// --- MAIN GAME LOOP & STATES ---
function initGame(){player=new Player;gameTime=0;score=0;enemies=[];playerProjectiles=[];enemyProjectiles=[];particles=[];floatingTexts=[];backgroundSpaceships=[];spaceshipSpawnTimer=5000;enemySpawnTimer=12e3;bossTimer=18e4;bossIsActive=false;eventTimer=random(15e3,3e4);levelColorIndex=0;currentTheme=THEMES[0];generateBackground();if (ytPlayer && typeof ytPlayer.playVideo === 'function') {if(gameDifficulty === 'nightmare') {ytPlayer.loadVideoById({videoId: 'g-s-aM02-2M'}); } else {ytPlayer.loadPlaylist({ listType: 'playlist', list: 'PLdsGes2mFh92eHpOZVJQgoubb6rF0CcvU', index: parseInt(Math.random() * 10) });} ytPlayer.playVideo();}}
function updatePlaying(){gameTime+=16.67;bossTimer-=16.67;if(bossTimer<=0&&!bossIsActive){playBossSpawnSound();enemies.push(new Enemy('boss',canvas.width/2,-100));bossIsActive=true;bossTimer=18e4}if(!bossIsActive)spawnEnemies();
if(!gameData.settings.performanceMode){spawnSpaceship(); backgroundSpaceships.forEach(s=>s.update()); backgroundSpaceships = backgroundSpaceships.filter(s=>!s.dead);}
[...enemies,...playerProjectiles,...enemyProjectiles,...particles,...floatingTexts].forEach(o=>o.update());player.update(); if(player.stats.wisp)player.stats.wisp.update();handleCollisions();particles=particles.filter(p=>p.l>0);floatingTexts=floatingTexts.filter(ft=>ft.lifespan>0);playerProjectiles=playerProjectiles.filter(p=>p.x>-p.radius&&p.x<canvas.width+p.radius&&p.y>-p.radius&&p.y<canvas.height+p.radius);enemyProjectiles=enemyProjectiles.filter(p=>p.x>-p.radius&&p.x<canvas.width+p.radius&&p.y>-p.radius&&p.y<canvas.height+p.radius)}
function drawPlaying(){ctx.save();if(screenShake.active&&screenShake.duration>0){ctx.translate(random(-screenShake.magnitude,screenShake.magnitude),random(-screenShake.magnitude,screenShake.magnitude));}
ctx.drawImage(skyCanvas,0,0);if(!gameData.settings.performanceMode){backgroundSpaceships.forEach(s=>s.draw());backgroundParticles.forEach(p=>p.draw());}
ctx.drawImage(terrainCanvas,0,0);
const boss=enemies.find(e=>e.type==='boss');if(boss&&boss.quakeWarningTimer>0){const alpha=0.3*Math.abs(Math.sin(boss.quakeWarningTimer*0.01));ctx.fillStyle=`rgba(255,0,0,${alpha})`;terrain.blocks.forEach(b=>{ctx.fillRect(b.x,b.y,b.width,b.height)})}
if(boss){boss.meteorTimers.forEach(m=>{if(m&&!m.visible){const indicatorSize=20;ctx.save();ctx.translate(m.x,30);ctx.fillStyle='red';ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-indicatorSize,indicatorSize);ctx.lineTo(indicatorSize,indicatorSize);ctx.closePath();ctx.fill();ctx.restore();} if(m)m.draw();});}
if(gameState !== 'gameOver'){player.draw(currentTheme);if(player.stats.wisp)player.stats.wisp.draw();}
enemies.forEach(e=>e.draw(currentTheme));playerProjectiles.forEach(p=>p.draw());enemyProjectiles.forEach(p=>p.draw());particles.forEach(p=>p.draw());floatingTexts.forEach(ft=>ft.draw());ctx.restore();}
function animate(){requestAnimationFrame(animate);ctx.clearRect(0,0,canvas.width,canvas.height);if(gameState==='intro'&&introTimer>0)introTimer-=16.67;if(restartTimer>0)restartTimer-=16.67;if(screenShake.active&&screenShake.duration>0){screenShake.duration-=16.67;}else{screenShake.active=false;}
if(!gameData.settings.performanceMode){if(gameState==='playing'||gameState==='menu'){spawnSpaceship();backgroundSpaceships.forEach(s=>s.update());backgroundSpaceships=backgroundSpaceships.filter(s=>!s.dead);} backgroundParticles.forEach(p=>p.update());}
switch(gameState){case 'intro': drawIntro(); break;case 'menu': drawMenu(); break;case 'playing': if (player) { updatePlaying(); drawPlaying(); drawPlayingUI(); } break;case 'paused': drawPauseScreen(); break;case 'levelUp': drawLevelUpScreen(); break;case 'pact': drawPactScreen(); break;case 'gameOver': drawGameOverScreen(); break}}

// --- EVENT LISTENERS ---
function handleFirstInteraction(){if(gameState==='intro'&&introTimer<=0){initAudio();gameState='menu';if(ytPlayer&&typeof ytPlayer.loadPlaylist==='function'){ytPlayer.loadPlaylist({listType:'playlist',list:'PLdsGes2mFh92eHpOZVJQgoubb6rF0CcvU',index:parseInt(Math.random()*10)});ytPlayer.playVideo();}}}
window.addEventListener('keydown',e=>{if(gameState==='intro'){handleFirstInteraction();return}if(e.code==='Escape'&&(gameState==='playing'||gameState==='paused')){playClickSound();if(gameState==='playing'){gameState='paused'; if(ytPlayer) ytPlayer.pauseVideo();}else{gameState='playing';if(ytPlayer) ytPlayer.playVideo();};return;}
if(gameState!=='playing'||!player)return;switch(e.code){case'KeyA':keys.a.p=true;break;case'KeyD':keys.d.p=true;break;case'Space':if(!keys.space.p){player.jump();keys.space.p=true}break;case'KeyF':if(!keys.f.p){player.activatePower('f');keys.f.p=true}break;case'KeyG':if(!keys.g.p){player.activatePower('g');keys.g.p=true}break;case'KeyJ':if(!keys.j.p){player.activatePower('j');keys.j.p=true}break;}});
window.addEventListener('keyup',e=>{if(gameState!=='playing'||!player)return;switch(e.code){case'KeyA':keys.a.p=false;break;case'KeyD':keys.d.p=false;break;case'Space':keys.space.p=false;break;case'KeyF':keys.f.p=false;break;case'KeyG':keys.g.p=false;break;case'KeyJ':keys.j.p=false;break;}});
canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;if(gameState==='menu'&&menuState==='settings'&&mouse.down){const s={x:canvas.width/2-150,y:460,w:300};if(mouse.x>=s.x&&mouse.x<=s.x+s.w){let v=Math.round((mouse.x-s.x)/s.w*100);gameData.settings.volume=Math.max(0,Math.min(100,v));if(ytPlayer)ytPlayer.setVolume(gameData.settings.volume)}}});
canvas.addEventListener('mousedown',()=>mouse.down=true);canvas.addEventListener('mouseup',()=>{mouse.down=false;if(gameState==='menu'&&menuState==='settings'){saveGameData();}});
canvas.addEventListener('click',e=>{handleFirstInteraction();if(gameState==='gameOver'&&restartTimer<=0){playClickSound();gameState='menu';menuState='main';return;}
if(gameState==='menu'){let currentButtons=[];if(menuState==='main')currentButtons=menuButtons;else if(menuState==='difficulty')currentButtons=difficultyButtons;else if(menuState==='settings')currentButtons=settingsButtons;else if(menuState==='binds')currentButtons=bindsButtons;currentButtons.forEach(b=>{if(mouse.x>b.x&&mouse.x<b.x+b.w&&mouse.y>b.y&&mouse.y<b.y+b.h)b.action()});
}else if(gameState==='paused'){pauseButtons.forEach(b=>{if(mouse.x>b.x&&mouse.x<b.x+b.w&&mouse.y>b.y&&mouse.y<b.y+b.h)b.action()});
}else if(gameState==='levelUp'){const cW=220,cH=300,gap=30;const tW=currentUpgradeChoices.length*cW+(currentUpgradeChoices.length-1)*gap;const sX=(canvas.width-tW)/2;const y=canvas.height/2-cH/2;currentUpgradeChoices.forEach((card,index)=>{const x=sX+index*(cW+gap);if(mouse.x>x&&mouse.x<x+cW&&mouse.y>y&&mouse.y<y+cH){playClickSound();if(card.type==='active'){if(!player.activeAbilities.f)player.activeAbilities.f=card;else if(!player.activeAbilities.g)player.activeAbilities.g=card;else if(!player.activeAbilities.j)player.activeAbilities.j=card;}else{const pUpgrade=player.upgrades[card.n];if(pUpgrade){if(pUpgrade.level<MAX_LEVEL){pUpgrade.level++;if(card.scaling)card.scaling(player);}}else{player.upgrades[card.n]={level:1};card.a(player);}}gameState='playing'}})}
else if(gameState==='pact'){const cardW=280,cardH=350,gap=50;const totalW=2*cardW+gap;const sX=(canvas.width-totalW)/2;const y=canvas.height/2-cardH/2;currentPactChoices.forEach((card,index)=>{const x=sX+index*(cardW+gap);if(mouse.x>x&&mouse.x<x+cardW&&mouse.y>y&&mouse.y<y+cardH){playClickSound();card.a(player);gameState='playing';}});}});

// --- START GAME ---
loadGameData();
createWorld();
setupMenus();
generateBackground();
animate();

</script>
</body>
</html>